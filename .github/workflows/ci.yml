name: "CI"

on:
  push:
    branches:
      - master
      - main
  pull_request:
  workflow_dispatch:

jobs:
  python:
    name: "Python ğŸ"
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v6

      - name: ğŸ Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'
          cache: 'pip'

      - name: ğŸ“¥ Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: ğŸ” Lint with flake8
        run: |
          flake8 --ignore=W292,W503 --max-line-length=127 --show-source --statistics *.py app/*.py app/routes/*.py app/services/*.py app/clients/*.py app/utils/*.py tests/*.py tests/integration/*.py tests/unit/*.py

      - name: ğŸ§ª Run tests
        run: |
          python -m pytest tests/ --cov

  terraform:
    name: "Terraform ğŸ—ï¸"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: gcp
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v6

      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸ” Terraform Format
        run: terraform fmt -check -recursive

      - name: ğŸ“‹ Terraform Init
        run: terraform init -backend=false

      - name: ğŸ” Terraform Validate
        run: terraform validate

      - name: ğŸ”’ Setup TFLint
        uses: terraform-linters/setup-tflint@v6
        with:
          tflint_version: latest

      - name: ğŸ” Run TFLint
        run: tflint

      - name: ğŸ›¡ï¸ Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3

  shell:
    name: "Shell ğŸš"
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v6

      - name: ğŸ” ShellCheck
        run: |
          shellcheck tools/*.sh && shellcheck gcp/*.sh && shellcheck gcp/startup/*.sh

  docker:
    name: "Docker ğŸ³"
    needs: [python, terraform, shell]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v6

      - name: ğŸ—ï¸ Build Docker image
        run: |
          docker build -t google-cloud-github-runner .

      - name: ğŸš€ Start Docker container
        run: |
          docker run -d --name google-cloud-github-runner -p 8080:8080 google-cloud-github-runner

      - name: â³ Wait for container to be ready
        run: |
          # Wait for up to 30 seconds for the service to respond
          for i in {1..30}; do
            if curl -s http://localhost:8080 > /dev/null; then
              echo "Container is ready!"
              exit 0
            fi
            echo "Waiting for container... ($i/30)"
            sleep 1
          done
          echo "Container failed to start in time"
          docker logs google-cloud-github-runner
          exit 1

      - name: ğŸ” Access Container web app via curl
        run: |
          curl -v http://localhost:8080

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          docker stop google-cloud-github-runner || true
          docker rm google-cloud-github-runner || true
